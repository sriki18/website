<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="/assets/css/style.css?v=6ce6eaae50b06a5ed8287355c43ff5a217329c8d">
    <link rel="stylesheet" type="text/css" href="/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Differential Evolution - Markov Chain | Musings</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Differential Evolution - Markov Chain" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/demc.html" />
<meta property="og:url" content="http://localhost:4000/demc.html" />
<meta property="og:site_name" content="Musings" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/demc.html","headline":"Differential Evolution - Markov Chain","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <!-- <script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js">
</script> -->
  <!-- <script type="text/javascript"
  src="projects/MathJax/MathJax.js">
</script> -->
<script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_CHTML">
</script>
  <body>
    <div class="sidenav">
            <a href="index">Home</a>
            <a href="demc" title="Differential Evolution Markov Chain">DE-MC</a>
            <a href="rhat" title="The Gelman-Rubin diagnostic">Rhat</a>
    </div>

    <!-- <div class="vertical-menu">
            <a href="#" class="active">Home</a>
            <a href="/">home</a>
            <a href="interval_plot">interval_plot</a>
            <a href="test_2">test_2</a>
    </div>  -->

    <div id="container">
      <div class="inner">

        <header>
          <h1>Differential Evolution - Markov Chain</h1>
          <h2></h2>
        </header>
        <section id="downloads" class="clearfix">
          
	
        </section>
        <hr>
        <section id="main_content">
          <h1 id="introduction">Introduction</h1>

<p>The Differential Evolution - Markov Chain<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> is an optimization algorithm for real parameter spaces. It provides posterior distribution samples of the parameters, rather than point estimates. This helps quantify the uncertainty in that parameter.</p>

<p>The Differential Evolution<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> component of the algorithm is used to generate candidate solutions, which are either accepted or rejected according to the Metropolis ratio. Since candidate solutions are generated by this method, the proposal or jumping distribution does not have to be tuned. Practically, this translates to the algorithm producing good posterior on difficult optimization problems and avoiding local minima.</p>

<p>Like Differential Evolution, a <em>population</em> of solutions is evolved to constitute the Markov Chain. Again, this presents a great practical advantage because model evaluation can be parallelized. This saves a lot of time when the most expensive step is evaluating the model.</p>

<p>I used this algorithm to estimate the parameters of my model<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup> that tracks the flow of viruses from water used to irrigate plants to the final produce. Human viruses, if present in the irrigation water, can internalize into the plant tissue and potentially cause infections in the people who eat such produce.</p>

<h1 id="commented-matlab-code">Commented MATLAB code</h1>

<p>The commented MATLAB code implementing this algorithm can be downloaded from the Github associated with my viral transport model <a href="https://github.com/JiangLabUCI/ViralTransport/blob/master/functions/DE_MC.m">here</a>.</p>

<p><img src="/assets/DEMC/DE_MC.PNG" alt="Check out the repository!" /></p>

<h1 id="example-usage">Example usage</h1>

<p>To demonstrate the syntax and usage of the function, here is a minimal example. Suppose we have some data that we know is normally distributed. The mean (μ or <code class="highlighter-rouge">mu</code>) and standard deviation (σ or <code class="highlighter-rouge">sigma</code>)  are unknown and to be estimated by DE-MC. The following snippet sets up this problem and calls the DE-MC function.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">% Generate normally distributed data</span>
<span class="n">mu_real</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">sig_real</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">randn</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sig_real</span> <span class="o">+</span> <span class="n">mu_real</span><span class="p">;</span>

<span class="c1">% Define the inputs for DE-MC</span>
<span class="n">maxGen</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="n">Npop</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span> <span class="n">ub</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">];</span>
<span class="n">genlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">maxGen</span><span class="p">;</span>
<span class="nb">reset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">x2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

<span class="n">solset</span> <span class="o">=</span> <span class="n">DE_MC</span><span class="p">(</span><span class="o">@</span><span class="n">example_objective</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">,</span><span class="n">maxGen</span><span class="p">,</span><span class="n">Npop</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="nb">reset</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="model-diagnostics">Model Diagnostics</h2>

<p>The first step to diagnosing the model output is visualizing the objective function. This is easily done with the following snippet:</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">plot</span><span class="p">(</span><span class="n">solset</span><span class="o">.</span><span class="n">Flist</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Generations'</span><span class="p">);</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s1">'Objective value'</span><span class="p">);</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'fontsize'</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/DEMC/objplot.png" alt="Plot of the objective function value across generations" /></p>

<p>The different colors represent the different chains which were run in parallel. Eyeballing the plot suggests convergence, but I sometimes like to look at the log of the objective functions or the post warm-up (or burn-in) period:</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span> <span class="s1">'Position'</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="nb">log10</span><span class="p">(</span><span class="n">solset</span><span class="o">.</span><span class="n">Flist</span><span class="p">),</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Generations'</span><span class="p">);</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s1">'Log_{10}(Objective value)'</span><span class="p">);</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'fontsize'</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>

<span class="nb">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">maxGen</span><span class="p">/</span><span class="mi">2</span><span class="p">:</span><span class="n">maxGen</span><span class="p">,</span> <span class="n">solset</span><span class="o">.</span><span class="n">Flist</span><span class="p">(</span><span class="n">maxGen</span><span class="p">/</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,:),</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Generations'</span><span class="p">);</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s1">'Objective value'</span><span class="p">);</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'fontsize'</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/DEMC/zoom_objplot.png" alt="Plot of log objective value and the objective value after warm-up" /></p>

<p>We do not see any outlier chains in the log objective plot (left). Also there is good mixing in the objective plot after the warm-up period, suggesting convergence to the optimum. One can also look at the mixing of the parameters with:</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span> <span class="s1">'Position'</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">maxGen</span><span class="p">/</span><span class="mi">2</span><span class="p">:</span><span class="n">maxGen</span><span class="p">,</span> <span class="n">solset</span><span class="o">.</span><span class="n">Xlist</span><span class="p">(</span><span class="n">maxGen</span><span class="p">/</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="n">lw</span><span class="p">);</span>
<span class="nb">hold</span> <span class="n">on</span><span class="p">;</span> <span class="n">yline</span><span class="p">(</span><span class="n">mu_real</span><span class="p">,</span> <span class="s1">'--'</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="n">lw</span><span class="p">);</span> <span class="nb">hold</span> <span class="n">off</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Generations'</span><span class="p">);</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s1">'\mu'</span><span class="p">);</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'fontsize'</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">maxGen</span><span class="p">/</span><span class="mi">2</span><span class="p">:</span><span class="n">maxGen</span><span class="p">,</span> <span class="n">solset</span><span class="o">.</span><span class="n">Xlist</span><span class="p">(</span><span class="n">maxGen</span><span class="p">/</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,:,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="n">lw</span><span class="p">);</span>
<span class="nb">hold</span> <span class="n">on</span><span class="p">;</span> <span class="n">yline</span><span class="p">(</span><span class="n">sig_real</span><span class="p">,</span> <span class="s1">'--'</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="n">lw</span><span class="p">);</span> <span class="nb">hold</span> <span class="n">off</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Generations'</span><span class="p">);</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s1">'\sigma'</span><span class="p">);</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'fontsize'</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/DEMC/mixing.png" alt="Plot of the sampled posteriors over generations" /></p>

<p>Again, we see good mixing without any outlier chains. The original values (<code class="highlighter-rouge">mu_real</code> and <code class="highlighter-rouge">sig_real</code>) are given by the dotted lines. Since the chains oscillate around the assumed <code class="highlighter-rouge">mu_real</code> and <code class="highlighter-rouge">sig_real</code>, convergence is confirmed. (Note that the oscillations are small as indicated by the Y axis units).</p>

<h3 id="note-1">Note 1</h3>

<p>In this example case, it was easy to verify convergence by comparing with <code class="highlighter-rouge">mu_real</code> and <code class="highlighter-rouge">sigma_real</code>. Yet, in practice, convergence cannot be confirmed easily, only supported. The Rhat metric or the Gelman-Rubin diagnostic is one such metric and is discussed <a href="rhat"> here </a>.</p>

<h2 id="obtaining-posteriors">Obtaining posteriors</h2>

<p>The parameter posteriors can be extracted from the chains with the following snippet, taking care to remove the warm-up period as follows:</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X_chains</span> <span class="o">=</span> <span class="n">solset</span><span class="o">.</span><span class="n">Xlist</span><span class="p">(</span><span class="n">maxGen</span><span class="p">/</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,:,:);</span> <span class="c1">% Remove warm-up</span>
<span class="n">X_post</span> <span class="o">=</span> <span class="nb">nan</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">X_chains</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="nb">size</span><span class="p">(</span><span class="n">X_chains</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">size</span><span class="p">(</span><span class="n">X_chains</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="k">for</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">X_chains</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">X_post</span><span class="p">(</span><span class="n">ind</span><span class="p">,:)</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">X_chains</span><span class="p">(:,:,</span><span class="n">ind</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">size</span><span class="p">(</span><span class="n">X_post</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="k">end</span>
<span class="n">mu_post</span> <span class="o">=</span> <span class="n">X_post</span><span class="p">(</span><span class="mi">1</span><span class="p">,:);</span> <span class="n">sig_post</span> <span class="o">=</span> <span class="n">X_post</span><span class="p">(</span><span class="mi">2</span><span class="p">,:);</span>
</code></pre></div></div>

<p>These samples can then be used to summarize the inferred parameter or can be plotted:</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">fprintf</span><span class="p">(</span><span class="s1">'Predicted mu = %2.2f, sigma = %2.2f \n'</span><span class="p">,</span> <span class="nb">mean</span><span class="p">(</span><span class="n">mu_post</span><span class="p">),</span> <span class="k">...</span>
<span class="nb">mean</span><span class="p">(</span><span class="n">sig_post</span><span class="p">));</span>
<span class="nb">figure</span><span class="p">();</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">gca</span><span class="p">();</span>
<span class="n">s</span> <span class="o">=</span> <span class="nb">scatter</span><span class="p">(</span><span class="n">mu_post</span><span class="p">,</span> <span class="n">sig_post</span><span class="p">,</span> <span class="s1">'o'</span><span class="p">,</span> <span class="s1">'filled'</span><span class="p">,</span> <span class="s1">'SizeData'</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span><span class="k">...</span>
<span class="s1">'markeredgecolor'</span><span class="p">,</span> <span class="s1">'none'</span><span class="p">,</span><span class="s1">'markerfacecolor'</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">]);</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'\mu'</span><span class="p">);</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s1">'\sigma'</span><span class="p">);</span> <span class="nb">hold</span> <span class="n">on</span><span class="p">;</span>
<span class="nb">alpha</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="o">.</span><span class="mi">125</span><span class="p">)</span>
<span class="n">ksdensity</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">X_post</span><span class="s1">', '</span><span class="n">PlotFcn</span><span class="s1">', '</span><span class="nb">contour</span><span class="o">'</span><span class="p">);</span> <span class="nb">hold</span> <span class="n">off</span><span class="p">;</span>
<span class="n">h2</span> <span class="o">=</span> <span class="nb">findobj</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">,</span> <span class="s1">'contour'</span><span class="p">);</span>
<span class="n">h2</span><span class="o">.</span><span class="n">LineColor</span> <span class="o">=</span> <span class="s1">'k'</span><span class="p">;</span> <span class="n">h2</span><span class="o">.</span><span class="n">LineWidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'fontsize'</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
<span class="nb">legend</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">h2</span><span class="p">],</span> <span class="p">{</span><span class="s1">'Samples'</span><span class="p">,</span> <span class="s1">'Contour'</span><span class="p">})</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;</span> <span class="n">Predicted</span> <span class="n">mu</span> <span class="o">=</span> <span class="mf">4.01</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.01</span>
</code></pre></div></div>

<p><img src="/assets/DEMC/post.png" alt="Scatter plot of the sampled posteriors" /></p>

<h3 id="note-2">Note 2</h3>

<p>If you use or modify the DE_MC code in your research, please cite <sup id="fnref:3:1"><a href="#fn:3" class="footnote">3</a></sup>!</p>

<h2 id="references">References</h2>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Ter Braak, C. J. F. (2006). A Markov Chain Monte Carlo version of the genetic algorithm Differential Evolution: Easy Bayesian computing for real parameter spaces. Statistics and Computing, 16(3), 239–249. <a href="https://doi.org/10.1007/s11222-006-8769-1">https://doi.org/10.1007/s11222-006-8769-1</a> <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Storn, R., &amp; Price, K. (1997). Differential Evolution – A Simple and Efficient Heuristic for global Optimization over Continuous Spaces. Journal of Global Optimization, 11(4), 341–359. <a href="https://doi.org/10.1023/A:1008202821328">https://doi.org/10.1023/A:1008202821328</a> <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>Chandrasekaran, S., &amp; Jiang, S. C. (2018). A dynamic transport model for quantification of norovirus internalization in lettuce from irrigation water and associated health risk. Science of The Total Environment, 643, 751–761. <a href="https://doi.org/10.1016/j.scitotenv.2018.06.158">https://doi.org/10.1016/j.scitotenv.2018.06.158</a> <a href="#fnref:3" class="reversefootnote">&#8617;</a> <a href="#fnref:3:1" class="reversefootnote">&#8617;<sup>2</sup></a></p>
    </li>
  </ol>
</div>

        </section>

        <!-- <section>
            <nav>
                <a href="/">home</a> |
                <a href="interval_plot">interval_plot</a> |
                <a href="test_2">test_2</a> |
            </nav>
        </section> -->

        <footer>
        
          Musings is maintained by <a href="http://github.com/sriki18">sriki18</a><br>
        
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

      </div>
    </div>


    
  </body>
</html>